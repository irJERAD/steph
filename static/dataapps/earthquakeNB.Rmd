---
title: "Earthquake Notebook"
output:
  html_document:
    self_contained: true
    theme: yeti
    highlight: pygments
    df_print: paged
    toc: true
    toc_float: true
---


# Earthquake Analysis

## Setup

### Libraries

```{r libraries, message=FALSE}
library(tidyverse)
library(RCurl)
library(plotly)
library(data.table)
library(DT)
library(httr)
```
## Data

### Static Datasets
 *cache data in notebook to have access to most recent when not connect to internet*
```{r global earthquake data, cache=T}
dl <- getURL('https://www.engineeringbigdata.com/wp-content/uploads/earthquake_all.csv')
gEQdata <- read_csv(file = dl)
```

### Explore Data

```{r summary}
summary(gEQdata, na.rn=T)
```
### Statistics
```{r}
sum <- summary(gEQdata$mag, na.rm=T)
sum
```

<br>

#### Magnitude  

Summary statistics for Global Earthquake Dataset
**Maximum:** `r sum["Max."]` **Minimum:** `r sum["Min."]`

**Median:** `r sum["Median"]` **Mean:** `r sum["Mean"]` 

### Reduce Dataset

According to [UPSeis](http://www.geo.mtu.edu/UPSeis/magnitude.html) an Earthquake with a magnitude of greater than 6 is significant

```{r}
Sig6Quake <- gEQdata[gEQdata$mag > 6,]
Sig6sum <- summary(Sig6Quake$mag, na.rm=T)
Sig5Quake <- gEQdata[gEQdata$mag > 5,]
Sig5sum <- summary(Sig5Quake$mag, na.rm=T)
Sig5sum
```

#### Earthquake Magnitude Classes

```{r}
# sort classes
greatcnt <- count(gEQdata[gEQdata$mag>=8,])
majorcnt <- count(gEQdata[gEQdata$mag>=7,])
strongcnt <- count(gEQdata[gEQdata$mag>=6,])
moderatecnt <- count(gEQdata[gEQdata$mag>=5,])
lightcnt <- count(gEQdata[gEQdata$mag>=4,])
minorcnt <- count(gEQdata)
```


```{r}
magClasses <- data.table(Class = 
                            c("Great","Major","Strong","Moderate",
                              "Light","Minor"),
                        Magn = 
                            c("8 or more","7 - 7.9","6 - 6.9","5 - 5.9",
                              "4 - 4.9","3.9 and under"),
                        Est_Each_Year =
                            c("one every 5 to 10 years","20","100",
                              "500","50,000","990,000"),
                        Est_Each_Month =
                            c("0","1.5","8.3","41.6","2,500","75,000"),
                        This_Month =
                            c(greatcnt,majorcnt,strongcnt,moderatecnt,
                              lightcnt,minorcnt))

names(magClasses)[2] <- "Magnitude"
names(magClasses)[3] <- "Estimated Each Year"
names(magClasses)[4] <- "Estimated Each Month"
names(magClasses)[5] <- "This Month"

datatable(magClasses, rownames = F)
```
 The numbers on this table show us that the month from December 26m 2017 until January 25, 2018 has **fewer Minor class earthquakes than normal**. <br>
There are **more Great class**, <br>
**4 times as many Major Class**, <br>
and **over 10% more Strong class Earthquakes**. <br>

Fit given points of Magnitude and Number of Earthquakes
```{r plotly fit, warning=FALSE}

mag <- c(2.5,5.5,6.1,7.0,8.0)

count <- c(900000,30000,500,100,20)

dt <- data.table(mag, count)

p <- plot_ly(dt, x = ~mag) %>% 
    add_markers(y = ~count)

pl <- p %>% add_lines(y= ~fitted(loess(count ~ mag)))

pl
```



## Visualize Data  

### Bubble Map  

[Plotly Bubble Map](https://plot.ly/r/bubble-maps/)

```{r bubble map}
# use Magnitude 5 and above events
Sig5Quake <- gEQdata[gEQdata$mag > 5,]
names(Sig5Quake)[2] <- "lat"
names(Sig5Quake)[3] <- "lon"

g <- list(
  #scope = 'usa',
  #projection = list(type = 'albers usa'),
  showland = TRUE,
  landcolor = toRGB("gray85"),
  subunitwidth = 1,
  countrywidth = 1,
  subunitcolor = toRGB("white"),
  countrycolor = toRGB("white")
)

p <- plot_geo(Sig5Quake, locationmode = 'USA-states', sizes = c(1, 250)) %>%
  add_markers(
    x = ~lon, y = ~lat, size = ~mag, color = ~magError, hoverinfo = "text",
    text = ~paste(Sig5Quake$mag, "Magnitude","<br>",
                  Sig5Quake$place, "<br />",
                  Sig5Quake$time)
  ) %>%
  layout(title = 'Dec 26, 2017 to January 25, 2018 Earthquakes over Magnitude 5', geo = g)

p
```

```{r}
request <- GET('https://earthquake.usgs.gov/fdsnws/event/1/query?format=csv&starttime=2014-01-01&endtime=2014-01-02&minmagnitude=5')
```

